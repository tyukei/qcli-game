<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>575Âà§ÂÆö„Ç≤„Éº„É†</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        
        .title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .score { color: #4CAF50; }
        .time { color: #FF5722; }
        
        .text-display {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.5em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
        }
        
        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-yes {
            background: #4CAF50;
            color: white;
        }
        
        .btn-no {
            background: #f44336;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .start-btn {
            background: #2196F3;
            color: white;
            padding: 20px 40px;
            font-size: 1.5em;
        }
        
        .result {
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            min-height: 30px;
        }
        
        .correct { color: #4CAF50; }
        .incorrect { color: #f44336; }
        
        .ending {
            display: none;
            text-align: center;
        }
        
        .ending h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        .ending-excellent {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .ending-good {
            background: linear-gradient(45deg, #87CEEB, #4682B4);
            color: white;
        }
        
        .ending-normal {
            background: linear-gradient(45deg, #98FB98, #32CD32);
            color: #333;
        }
        
        .ending-poor {
            background: linear-gradient(45deg, #FFB6C1, #FF69B4);
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="title">üéØ 575Âà§ÂÆö„Ç≤„Éº„É†</h1>
        
        <div id="gameArea">
            <div class="game-info">
                <div class="score">„Çπ„Ç≥„Ç¢: <span id="score">0</span></div>
                <div class="time">ÊÆã„ÇäÊôÇÈñì: <span id="timeLeft">30</span>Áßí</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            
            <div class="text-display" id="textDisplay">
                „Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </div>
            
            <div class="result" id="result"></div>
            
            <div class="buttons">
                <button class="btn start-btn" id="startBtn" onclick="startGame()">„Ç≤„Éº„É†ÈñãÂßã</button>
                <button class="btn btn-yes" id="yesBtn" onclick="answer(true)" disabled>575„Åß„ÅÇ„Çã (Y)</button>
                <button class="btn btn-no" id="noBtn" onclick="answer(false)" disabled>575„Åß„Å™„ÅÑ (N)</button>
            </div>
        </div>
        
        <div class="ending" id="ending">
            <h2 id="endingTitle"></h2>
            <p id="endingMessage"></p>
            <p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore"></span></p>
            <button class="btn start-btn" onclick="resetGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
        </div>
    </div>

    <script>
        // Ë®≠ÂÆöÁÆ°ÁêÜ
        let GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';
        
        // config.js„Åã„ÇâË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
        if (typeof window.CONFIG !== 'undefined' && window.CONFIG.GEMINI_API_KEY) {
            GEMINI_API_KEY = window.CONFIG.GEMINI_API_KEY;
        }

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            isPlaying: false,
            score: 0,
            timeLeft: 30,
            currentText: '',
            currentAnswer: false,
            timer: null
        };

        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent';

        // Èü≥Êï∞„Ç´„Ç¶„É≥„ÉàÈñ¢Êï∞Ôºà„Å≤„Çâ„Åå„Å™„Éª„Ç´„Çø„Ç´„ÉäÂØæÂøúÔºâ
        function countMora(text) {
            const cleanText = text.replace(/[\n\r\s]/g, '');
            const smallKana = /[„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ„ÇÉ„ÇÖ„Çá„Å£„Ç°„Ç£„Ç•„Çß„Ç©„É£„É•„Éß„ÉÉ]/g;
            
            let count = 0;
            for (let i = 0; i < cleanText.length; i++) {
                const char = cleanText[i];
                
                if (smallKana.test(char)) {
                    continue;
                }
                
                if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(char)) {
                    count++;
                }
            }
            
            return count;
        }

        // 575Âà§ÂÆöÈñ¢Êï∞
        function check575(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length !== 3) {
                return false;
            }
            
            const counts = lines.map(line => countMora(line.trim()));
            return counts[0] === 5 && counts[1] === 7 && counts[2] === 5;
        }

        // Gemini API„Çí‰ΩøÁî®„Åó„Å¶„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
        async function generateTextWithGemini() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                console.log('API key not configured, using fallback');
                return generateTextFallback();
            }

            try {
                const shouldBe575 = Math.random() < 0.4;
                
                let prompt;
                if (shouldBe575) {
                    prompt = `Êó•Êú¨Ë™û„Åß5-7-5„ÅÆÈü≥Âæã„ÅÆ‰ø≥Âè•„Çí1„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂ≠£Ë™û„ÇíÂê´„ÇÅ„Å¶„ÄÅËá™ÁÑ∂„ÇÑÊó•Â∏∏„ÅÆÁæé„Åó„ÅÑÁû¨Èñì„ÇíË°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîπË°å„Åß3Ë°å„Å´ÂàÜ„Åë„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö
Ê°úÊï£„Çä
È¢®„Å´Ëàû„ÅÑË∏ä„Çã
Ëä±„Å≥„Çâ„Çà`;
                } else {
                    const patterns = [
                        'Êó•Êú¨Ë™û„Åß5-7-7„ÅÆÈü≥Âæã„ÅÆÁü≠Ë©©„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîπË°å„Åß3Ë°å„Å´ÂàÜ„Åë„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'Êó•Êú¨Ë™û„Åß7-5-5„ÅÆÈü≥Âæã„ÅÆÁü≠Ë©©„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîπË°å„Åß3Ë°å„Å´ÂàÜ„Åë„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'Êó•Êú¨Ë™û„Åß4-6-4„ÅÆÈü≥Âæã„ÅÆÁü≠Ë©©„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîπË°å„Åß3Ë°å„Å´ÂàÜ„Åë„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'Êó•Êú¨Ë™û„ÅßÁü≠„ÅÑË©©„Çí2Ë°å„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂêÑË°å„ÅØ6-8Èü≥Á®ãÂ∫¶„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    ];
                    prompt = patterns[Math.floor(Math.random() * patterns.length)];
                }

                console.log('Calling Gemini API...');
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Error ${response.status}:`, errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response structure');
                }
                
                const generatedText = data.candidates[0].content.parts[0].text.trim();
                const is575 = check575(generatedText);
                
                console.log('Generated text:', generatedText);
                console.log('Is 575:', is575);
                
                return {
                    text: generatedText,
                    is575: is575
                };

            } catch (error) {
                console.error('Gemini API Error:', error);
                console.log('Falling back to local generation');
                return generateTextFallback();
            }
        }

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
        function generateTextFallback() {
            const haikuSamples = [
                // 575„ÅÆ‰ø≥Âè•„Çµ„É≥„Éó„É´
                { text: "„Åï„Åè„Çâ„Åï„Åè\n„Åã„Åú„Å´„Åæ„ÅÑ„Åä„Å©„Çã\n„ÅØ„Å™„Å≥„Çâ„Çà", is575: true },
                { text: "„ÅÇ„Åä„Åû„Çâ„Å´\n„Åó„Çç„ÅÑ„Åè„ÇÇ„Åå„Å™„Åå„Çå\n„Å®„Çä„Åå„Å™„Åè", is575: true },
                { text: "„ÇÜ„ÇÅ„Åø„Å¶„Çã\n„Çà„Çã„ÅÆ„Åó„Åö„Åã„Å™„Å®„Åç\n„Å§„Åç„Å≤„Åã„Çä", is575: true },
                { text: "„Åã„Åú„Åµ„ÅÑ„Å¶\n„Åø„Å©„Çä„ÅÆ„ÅØ„Å£„Å±„ÇÜ„Çå\n„Å™„Å§„ÅÆ„Å≤„Å≥", is575: true },
                { text: "„ÅÇ„ÇÅ„Åµ„Å£„Å¶\n„Åø„Åö„Åü„Åæ„Çä„Å´„ÅÜ„Å§„Çã\n„Åù„Çâ„ÅÆ„ÅÑ„Çç", is575: true },
                
                // 575„Åß„Å™„ÅÑ„Çµ„É≥„Éó„É´
                { text: "„Å≠„Åì„Åå„ÅÑ„Çã\n„Å´„Çè„ÅÆ„Åô„Åø„Å£„Åì„Åß„Å≠„Å¶\n„Å≤„Å™„Åü„Åº„Å£„Åì„Åó„Å¶„Çã", is575: false },
                { text: "„ÅÇ„Åã„ÅÑ„ÅØ„Å™„Åå\n„Åï„ÅÑ„Å¶„ÅÑ„Çã\n„Åç„Çå„ÅÑ„Å†„Å™", is575: false },
                { text: "„Åä„Åä„Åç„Å™„Åç\n„Å°„ÅÑ„Åï„Å™„Å®„Çä\n„Åù„Çâ„Çí„Å®„Å∂", is575: false },
                { text: "„ÅÜ„Åø„Åå„Åø„Åà„Çã\n„Å™„Åø„ÅÆ„Åä„Å®„Åå„Åç„Åì„Åà„Å¶\n„Åç„ÇÇ„Å°„ÅÑ„ÅÑ", is575: false },
                { text: "„Åª„Åó„Åå„Åã„Åå„ÇÑ„Åè\n„Çà„Çã„ÅÆ„Åù„Çâ\n„Åç„Çå„ÅÑ", is575: false }
            ];
            
            const shouldBe575 = Math.random() < 0.4;
            const filteredSamples = haikuSamples.filter(sample => sample.is575 === shouldBe575);
            const randomSample = filteredSamples[Math.floor(Math.random() * filteredSamples.length)];
            
            console.log('Using fallback generation:', randomSample);
            return randomSample;
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.timeLeft = 30;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('yesBtn').disabled = false;
            document.getElementById('noBtn').disabled = false;
            document.getElementById('ending').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            updateDisplay();
            nextQuestion();
            startTimer();
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateDisplay();
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // Ê¨°„ÅÆÂïèÈ°å
        function nextQuestion() {
            if (!gameState.isPlaying) return;
            
            document.getElementById('textDisplay').innerHTML = 'ÁîüÊàê‰∏≠...';
            document.getElementById('yesBtn').disabled = true;
            document.getElementById('noBtn').disabled = true;
            
            generateTextWithGemini().then(generated => {
                if (!gameState.isPlaying) return;
                
                gameState.currentText = generated.text;
                gameState.currentAnswer = generated.is575;
                
                document.getElementById('textDisplay').innerHTML = gameState.currentText.replace(/\n/g, '<br>');
                document.getElementById('result').textContent = '';
                document.getElementById('yesBtn').disabled = false;
                document.getElementById('noBtn').disabled = false;
            }).catch(error => {
                console.error('Text generation error:', error);
                const generated = generateTextFallback();
                gameState.currentText = generated.text;
                gameState.currentAnswer = generated.is575;
                
                document.getElementById('textDisplay').innerHTML = gameState.currentText.replace(/\n/g, '<br>');
                document.getElementById('result').textContent = '';
                document.getElementById('yesBtn').disabled = false;
                document.getElementById('noBtn').disabled = false;
            });
        }

        // ÂõûÁ≠îÂá¶ÁêÜ
        function answer(userAnswer) {
            if (!gameState.isPlaying) return;
            
            const isCorrect = userAnswer === gameState.currentAnswer;
            const resultElement = document.getElementById('result');
            
            if (isCorrect) {
                gameState.score++;
                resultElement.textContent = 'Ê≠£Ëß£ÔºÅ';
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‰∏çÊ≠£Ëß£... (Ê≠£Ëß£: ${gameState.currentAnswer ? '575„Åß„ÅÇ„Çã' : '575„Åß„Å™„ÅÑ'})`;
                resultElement.className = 'result incorrect';
            }
            
            updateDisplay();
            
            setTimeout(() => {
                nextQuestion();
            }, 1000);
        }

        // Ë°®Á§∫Êõ¥Êñ∞
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('timeLeft').textContent = gameState.timeLeft;
            
            const progressPercent = ((30 - gameState.timeLeft) / 30) * 100;
            document.getElementById('progressBar').style.width = progressPercent + '%';
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timer);
            
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('ending').style.display = 'block';
            document.getElementById('finalScore').textContent = gameState.score;
            
            const endingContainer = document.getElementById('ending');
            const endingTitle = document.getElementById('endingTitle');
            const endingMessage = document.getElementById('endingMessage');
            
            if (gameState.score >= 12) {
                endingContainer.className = 'ending ending-excellent';
                endingTitle.textContent = 'üèÜ ‰ø≥Âè•„Éû„Çπ„Çø„ÉºÔºÅ';
                endingMessage.textContent = 'Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ„ÅÇ„Å™„Åü„ÅØÁúü„ÅÆ‰ø≥Âè•„ÅÆÈÅî‰∫∫„Åß„Åô„ÄÇ575„ÅÆÊÑüË¶ö„ÅåÂÆåÁíß„Å´Ë∫´„Å´„Å§„ÅÑ„Å¶„ÅÑ„Åæ„Åô„Å≠ÔºÅ';
            } else if (gameState.score >= 9) {
                endingContainer.className = 'ending ending-good';
                endingTitle.textContent = 'üåü ‰ø≥Âè•‰∏äÁ¥öËÄÖÔºÅ';
                endingMessage.textContent = '„Å®„Å¶„ÇÇËâØ„ÅÑÊàêÁ∏æ„Åß„ÅôÔºÅ‰ø≥Âè•„ÅÆÂü∫Êú¨„Çí„Åó„Å£„Åã„ÇäÁêÜËß£„Åó„Å¶„ÅÑ„Åæ„Åô„Å≠„ÄÇ';
            } else if (gameState.score >= 6) {
                endingContainer.className = 'ending ending-normal';
                endingTitle.textContent = 'üìö ‰ø≥Âè•Â≠¶ÁøíËÄÖ';
                endingMessage.textContent = 'ËâØ„ÅÑË™øÂ≠ê„Åß„ÅôÔºÅ„ÇÇ„ÅÜÂ∞ë„ÅóÁ∑¥Áøí„Åô„Çå„Å∞„ÄÅ„Åï„Çâ„Å´‰∏äÈÅî„Åó„Åù„ÅÜ„Åß„Åô„Å≠„ÄÇ';
            } else {
                endingContainer.className = 'ending ending-poor';
                endingTitle.textContent = 'üå± ‰ø≥Âè•ÂàùÂøÉËÄÖ';
                endingMessage.textContent = '‰ø≥Âè•„ÅØÂ••„ÅåÊ∑±„ÅÑ„ÇÇ„ÅÆ„Åß„Åô„ÄÇ575„ÅÆ„É™„Ç∫„É†„ÇíÊÑèË≠ò„Åó„Å¶„ÄÅ„Åæ„ÅüÊåëÊà¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºÅ';
            }
        }

        // „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetGame() {
            gameState = {
                isPlaying: false,
                score: 0,
                timeLeft: 30,
                currentText: '',
                currentAnswer: false,
                timer: null
            };
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('yesBtn').disabled = true;
            document.getElementById('noBtn').disabled = true;
            document.getElementById('textDisplay').textContent = '„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            document.getElementById('result').textContent = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('ending').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            updateDisplay();
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (event) => {
            if (!gameState.isPlaying) return;
            
            if (event.key === 'y' || event.key === 'Y') {
                answer(true);
            } else if (event.key === 'n' || event.key === 'N') {
                answer(false);
            }
        });

        // ÂàùÊúüË°®Á§∫Êõ¥Êñ∞
        updateDisplay();
    </script>

    <!-- config.js„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØË™≠„ÅøËæº„Åø -->
    <script>
        // config.js„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
        const configScript = document.createElement('script');
        configScript.src = 'config.js';
        configScript.onload = function() {
            if (typeof window.CONFIG !== 'undefined' && window.CONFIG.GEMINI_API_KEY) {
                GEMINI_API_KEY = window.CONFIG.GEMINI_API_KEY;
                console.log('config.js loaded successfully');
            }
        };
        configScript.onerror = function() {
            console.log('config.js not found, using default configuration');
        };
        document.head.appendChild(configScript);
    </script>
</body>
</html>
